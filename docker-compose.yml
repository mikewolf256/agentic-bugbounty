services:
  mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    environment:
      - OUTPUT_DIR=/app/output_zap
      - NUCLEI_TEMPLATES_DIR=/app/nuclei-templates
      - PYTHONPATH=/app
      # Docker network name for katana/nuclei to use
      - DOCKER_NETWORK=agentic-bugbounty_lab_network
      # Lab testing mode - use higher rate limits since we control the lab
      - LAB_TESTING=true
    ports:
      - "8000:8000"
    volumes:
      - ./output_zap:/app/output_zap
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - lab_network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  juice-shop:
    image: bkimminich/juice-shop
    ports:
      - "3000:3000"
    networks:
      - lab_network

  # ===== Lab Services =====
  xss_js_secrets:
    build:
      context: ./labs/xss_js_secrets
    ports:
      - "5001:5000"
    networks:
      - lab_network

  idor_auth:
    build:
      context: ./labs/idor_auth
    ports:
      - "5002:5000"
    networks:
      - lab_network

  backup_leaks_fingerprint:
    build:
      context: ./labs/backup_leaks_fingerprint
    ports:
      - "5003:80"
    networks:
      - lab_network

  auth_scan_lab:
    build:
      context: ./labs/auth_scan_lab
    ports:
      - "5004:5000"
    networks:
      - lab_network

  # New vulnerability type labs
  xxe_lab:
    build:
      context: ./labs/xxe_lab
    ports:
      - "5005:5000"
    networks:
      - lab_network

  business_logic_lab:
    build:
      context: ./labs/business_logic_lab
    ports:
      - "5006:5000"
    networks:
      - lab_network

  cloud_lab:
    build:
      context: ./labs/cloud_lab
    ports:
      - "5007:5000"
    networks:
      - lab_network

  template_injection_lab:
    build:
      context: ./labs/template_injection_lab
    ports:
      - "5008:5000"
    networks:
      - lab_network

  deserialization_lab:
    build:
      context: ./labs/deserialization_lab
    ports:
      - "5009:5000"
    networks:
      - lab_network

  graphql_lab:
    build:
      context: ./labs/graphql_lab
    ports:
      - "5010:5000"
    networks:
      - lab_network

  grpc_lab:
    build:
      context: ./labs/grpc_lab
    ports:
      - "5011:5000"
      - "5012:50051"
    networks:
      - lab_network

  # Phase 1: Critical RCE Labs
  command_injection_lab:
    build:
      context: ./labs/command_injection_lab
    ports:
      - "5013:5000"
    networks:
      - lab_network

  path_traversal_lab:
    build:
      context: ./labs/path_traversal_lab
    ports:
      - "5014:5000"
    networks:
      - lab_network

  file_upload_lab:
    build:
      context: ./labs/file_upload_lab
    ports:
      - "5015:5000"
    networks:
      - lab_network

  # Phase 2: Common High-Value Labs
  csrf_lab:
    build:
      context: ./labs/csrf_lab
    ports:
      - "5016:5000"
    networks:
      - lab_network

  nosql_injection_lab:
    build:
      context: ./labs/nosql_injection_lab
    ports:
      - "5017:5000"
    networks:
      - lab_network

  # Phase 3: Specialized Injection & Protocol Labs
  ldap_injection_lab:
    build:
      context: ./labs/ldap_injection_lab
    ports:
      - "5018:5000"
    networks:
      - lab_network

  mass_assignment_lab:
    build:
      context: ./labs/mass_assignment_lab
    ports:
      - "5019:5000"
    networks:
      - lab_network

  websocket_lab:
    build:
      context: ./labs/websocket_lab
    ports:
      - "5020:5000"
      - "5021:5001"
    networks:
      - lab_network

  ssi_injection_lab:
    build:
      context: ./labs/ssi_injection_lab
    ports:
      - "5022:5000"
    networks:
      - lab_network

  # Phase 4: Advanced & Edge Case Labs
  crypto_weakness_lab:
    build:
      context: ./labs/crypto_weakness_lab
    ports:
      - "5023:5000"
    networks:
      - lab_network

  parameter_pollution_lab:
    build:
      context: ./labs/parameter_pollution_lab
    ports:
      - "5024:5000"
    networks:
      - lab_network

  dns_rebinding_lab:
    build:
      context: ./labs/dns_rebinding_lab
    ports:
      - "5025:5000"
    networks:
      - lab_network

  cache_poisoning_lab:
    build:
      context: ./labs/cache_poisoning_lab
    ports:
      - "5026:5000"
    networks:
      - lab_network

  random_generation_lab:
    build:
      context: ./labs/random_generation_lab
    ports:
      - "5027:5000"
    networks:
      - lab_network

networks:
  lab_network:
    driver: bridge

volumes:
  output_zap:
