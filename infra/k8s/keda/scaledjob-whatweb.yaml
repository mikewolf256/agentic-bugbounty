# KEDA ScaledJob for WhatWeb fingerprinting
# Automatically scales 0â†’N based on SQS queue depth
apiVersion: keda.sh/v1alpha1
kind: ScaledJob
metadata:
  name: whatweb-worker
  namespace: scan-workers
  labels:
    app.kubernetes.io/name: whatweb-worker
    app.kubernetes.io/component: scan-worker
spec:
  # Job template
  jobTargetRef:
    parallelism: 1
    completions: 1
    backoffLimit: 2
    ttlSecondsAfterFinished: 300  # Clean up completed jobs after 5 min
    template:
      metadata:
        labels:
          app.kubernetes.io/name: whatweb-worker
          app.kubernetes.io/component: scan-worker
      spec:
        serviceAccountName: scan-worker
        restartPolicy: Never
        containers:
          - name: whatweb
            image: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/agentic-bugbounty/whatweb-worker:latest
            imagePullPolicy: Always
            env:
              - name: AWS_REGION
                value: "${AWS_REGION}"
              - name: SQS_QUEUE_URL
                value: "${SQS_QUEUE_URL}"
              - name: S3_BUCKET
                value: "${S3_BUCKET}"
              - name: RESULTS_QUEUE_URL
                value: "${RESULTS_QUEUE_URL}"
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi
            # Liveness probe
            livenessProbe:
              exec:
                command:
                  - cat
                  - /tmp/healthy
              initialDelaySeconds: 30
              periodSeconds: 30
  
  # Polling interval for SQS
  pollingInterval: 15
  
  # Cooldown period before scaling down
  cooldownPeriod: 60
  
  # Min/Max concurrent jobs
  minReplicaCount: 0  # Scale to zero!
  maxReplicaCount: 20
  
  # How many jobs to run per trigger activation
  scalingStrategy:
    strategy: default
  
  # SQS trigger
  triggers:
    - type: aws-sqs-queue
      metadata:
        queueURL: ${SQS_QUEUE_URL}
        queueLength: "1"  # Trigger when 1+ messages in queue
        awsRegion: ${AWS_REGION}
        identityOwner: operator  # Use KEDA's IRSA role

